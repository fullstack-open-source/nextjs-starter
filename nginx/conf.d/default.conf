# ===========================================
# Next.js Frontend - Nginx Internal Proxy Configuration
# ===========================================
#
# This nginx instance acts as an internal reverse proxy for:
# - Next.js Application (app:3000)
# - Prisma Studio (app:5555)
# - Media files with aggressive caching
# - Static assets with long-term caching
#
# ROUTING:
# ────────────────────────────────────────────
# /prisma-studio → Prisma Studio (app:5555)
# /api/ → Next.js API Routes (app:3000)
# /uploads/ → Media Files (app:3000) - Cached
# /_next/ → Next.js Static Assets - Cached
# / → Next.js App (app:3000)
# ────────────────────────────────────────────
#
# Features:
# - WebSocket support for real-time features (Socket.io)
# - Aggressive caching for media and static files
# - Security headers
# - Rate limiting
# - Gzip compression
# - Proxy caching for better performance
# ===========================================

# WebSocket upgrade mapping
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# ===========================================
# Upstream - Next.js Application
# ===========================================

upstream nextjs_app {
    server app:3000;
    keepalive 32;
}

# ===========================================
# Upstream - Prisma Studio
# ===========================================

upstream prisma_studio {
    server app:5555;
    keepalive 8;
}

# ===========================================
# Server Block
# ===========================================

server {
    listen 80;
    server_name _;
    
    # Root for cache directories
    root /var/cache/nginx;
    
    # Security: Block invalid HTTP methods (allow OPTIONS for CORS)
    if ($request_method !~ ^(GET|HEAD|POST|PUT|PATCH|DELETE|OPTIONS)$ ) {
        return 405;
    }
    
    # Security: Block suspicious requests early
    # Note: These checks are less aggressive to avoid blocking legitimate requests
    # Only block if clearly malicious patterns are detected
    
    # Block suspicious user agents (only clearly malicious ones)
    if ($block_agent) {
        return 403;
    }
    
    # Block suspicious referers (only known spam domains)
    if ($block_referer) {
        return 403;
    }
    
    # Block suspicious query strings (XSS patterns in query params only)
    # This won't block legitimate API calls with query parameters
    if ($block_args) {
        return 403;
    }
    
    # Rate limiting (from security.conf - Next.js optimized)
    limit_conn conn_limit_per_ip 50;        # Increased for Next.js
    limit_conn conn_limit_per_server 2000;   # Increased for Next.js
    limit_req zone=req_limit_per_ip burst=50 nodelay;  # Increased burst for Next.js
    limit_req_status 429;
    limit_conn_status 429;
    
    # Security logging (blocked requests will be logged automatically)
    access_log /var/log/nginx/access.log main;
    access_log /var/log/nginx/security.log security;
    
    # Hide server information
    proxy_hide_header Server;
    proxy_hide_header X-Powered-By;

    # ───────────────────────────────────────
    # Health Check
    # ───────────────────────────────────────
    
    location = /health {
        proxy_pass http://nextjs_app/api/health;
        include /etc/nginx/proxy.conf;
        access_log off;
    }

    # ───────────────────────────────────────
    # Prisma Studio (Database Management)
    # SECURITY: Should only be accessible from trusted IPs
    # ───────────────────────────────────────
    
    location /prisma-studio {
        # IP Whitelist from PRISMA_STUDIO_ALLOWED_IPS in .env
        # Example: PRISMA_STUDIO_ALLOWED_IPS="1.2.3.4 5.6.7.8"
        include /tmp/prisma-studio-whitelist.conf;
        
        # Strict rate limiting for Prisma Studio
        limit_req zone=req_limit_per_ip_strict burst=5 nodelay;
        limit_conn conn_limit_per_ip 5;
        
        # Block non-GET/POST requests
        if ($request_method !~ ^(GET|POST|HEAD|OPTIONS)$) {
            return 405;
        }
        
        # Remove /prisma-studio prefix when proxying
        rewrite ^/prisma-studio/?(.*)$ /$1 break;
        rewrite ^/prisma-studio$ / break;
        
        proxy_pass http://prisma_studio;
        include /etc/nginx/proxy.conf;
        
        # WebSocket support for Prisma Studio (proxy.conf already has proxy_http_version)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # Extended timeouts for Prisma Studio
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        
        # No caching for Prisma Studio
        proxy_cache off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        
        # Security logging
        access_log /var/log/nginx/security.log security;
    }

    # ───────────────────────────────────────
    # WebSocket Support (for Socket.io)
    # ───────────────────────────────────────
    
    location /socket.io/ {
        proxy_pass http://nextjs_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        proxy_buffering off;
        proxy_cache off;
    }

    # ───────────────────────────────────────
    # Media Files - Aggressive Caching
    # ───────────────────────────────────────
    
    # Media uploads directory (public/uploads/)
    location /uploads/ {
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        
        # Enable proxy caching for media files
        proxy_cache media_cache;
        proxy_cache_valid 200 30d;      # Cache successful responses for 30 days
        proxy_cache_valid 404 1h;       # Cache 404s for 1 hour
        proxy_cache_valid any 1h;       # Cache other responses for 1 hour
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        
        # Cache key includes query string for access keys
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        # Add cache status header
        add_header X-Cache-Status $upstream_cache_status always;
        
        # Aggressive caching headers
        expires 30d;
        add_header Cache-Control "public, immutable, max-age=2592000";
        add_header Pragma "public";
        
        # CORS headers for media (if needed)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Content-Type" always;
        
        # Handle range requests for video/audio streaming
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        proxy_no_cache $http_range;
        
        # Logging
        access_log /var/log/nginx/media-access.log;
    }
    
    # Media API routes (with shorter cache)
    location ~ ^/api/media/(upload|statistics|folders) {
        # Allow larger files for uploads (must be at location level, not in if block)
        client_max_body_size 100M;
        
        # Strict rate limiting for upload endpoints
        limit_req zone=req_limit_per_ip_upload burst=2 nodelay;
        limit_conn conn_limit_per_ip 5;
        
        # Block suspicious file extensions in upload path
        if ($request_uri ~* "\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$") {
            return 403;
        }
        
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        proxy_read_timeout 120s;  # Longer timeout for uploads
        proxy_connect_timeout 10s;
        proxy_cache off;  # No cache for upload/management endpoints
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        
        # Security logging
        access_log /var/log/nginx/security.log security;
    }
    
    # Media API GET routes (with caching)
    location ~ ^/api/media/([^/]+)/?$ {
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        
        # Cache media metadata for 1 hour
        proxy_cache api_cache;
        proxy_cache_valid 200 1h;
        proxy_cache_valid 404 5m;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        add_header X-Cache-Status $upstream_cache_status always;
        
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
    }
    
    # Media access with access key (private media)
    location ~ ^/api/media/([^/]+)/access/([^/]+)$ {
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        
        # Cache private media with access key for 1 hour
        proxy_cache media_cache;
        proxy_cache_valid 200 1h;
        proxy_cache_valid 404 5m;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        add_header X-Cache-Status $upstream_cache_status always;
        
        # Handle range requests
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
        
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
    }

    # ───────────────────────────────────────
    # Static Files (Next.js static assets)
    # ───────────────────────────────────────
    
    location /_next/static/ {
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        
        # Aggressive caching for Next.js static assets
        proxy_cache static_cache;
        proxy_cache_valid 200 365d;
        proxy_cache_valid 404 1d;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        add_header X-Cache-Status $upstream_cache_status always;
        
        expires 365d;
        add_header Cache-Control "public, immutable, max-age=31536000";
        access_log off;
    }
    
    location /_next/image {
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        
        # Cache optimized images for 30 days
        proxy_cache static_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_valid 404 1h;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        add_header X-Cache-Status $upstream_cache_status always;
        
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }

    # ───────────────────────────────────────
    # Public Assets (images, fonts, etc.)
    # ───────────────────────────────────────
    
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|avif|woff|woff2|ttf|eot|otf)$ {
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        
        # Cache public assets aggressively
        proxy_cache static_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_valid 404 1d;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        add_header X-Cache-Status $upstream_cache_status always;
        
        expires 30d;
        add_header Cache-Control "public, immutable, max-age=2592000";
    }

    # ───────────────────────────────────────
    # API Routes
    # ───────────────────────────────────────
    
    # API routes that should be cached
    location ~ ^/api/(project/information|media/statistics|media/folders)$ {
        # CORS headers
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-Session-Token" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # Handle OPTIONS preflight
        if ($request_method = OPTIONS) {
            add_header Access-Control-Max-Age 3600 always;
            return 204;
        }
        
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        
        # Cache API responses for 5 minutes
        proxy_cache api_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_valid 404 1m;
        proxy_cache_key "$scheme$request_method$host$request_uri$is_args$args";
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        add_header X-Cache-Status $upstream_cache_status always;
        
        # Allow stale-while-revalidate
        add_header Cache-Control "public, max-age=300, stale-while-revalidate=60";
        
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
    }
    
    # Authentication endpoints (separate for better control)
    location ~ ^/api/auth/ {
        # CORS headers
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-Session-Token" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # Handle OPTIONS preflight FIRST
        if ($request_method = OPTIONS) {
            add_header Access-Control-Max-Age 3600 always;
            return 204;
        }
        
        # Rate limiting for authentication endpoints
        limit_req zone=req_limit_per_ip_login burst=10 nodelay;  # Increased for Next.js
        limit_conn conn_limit_per_ip 10;
        
        # Block SQL injection patterns in query string only (not in path)
        if ($args ~* "(union.*select|insert.*into|delete.*from|drop.*table|create.*table|alter.*table|exec.*\(|execute.*\()") {
            return 403;
        }
        
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_cache off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        
        # Security logging
        access_log /var/log/nginx/security.log security;
    }
    
    # API routes that should NOT be cached (users, activity, media mutations, settings)
    location ~ ^/api/(users|activity|media/(upload|delete|update)|settings) {
        # CORS headers
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-Session-Token" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # Handle OPTIONS preflight FIRST
        if ($request_method = OPTIONS) {
            add_header Access-Control-Max-Age 3600 always;
            return 204;
        }
        
        # General rate limiting for sensitive endpoints
        limit_req zone=req_limit_per_ip_strict burst=20 nodelay;  # Increased for Next.js
        limit_conn conn_limit_per_ip 20;
        
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_cache off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        
        # Security logging
        access_log /var/log/nginx/security.log security;
    }
    
    # Default API routes (with minimal caching) - catch-all for other API routes
    location /api/ {
        # CORS headers
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-Session-Token" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # Handle OPTIONS preflight FIRST
        if ($request_method = OPTIONS) {
            add_header Access-Control-Max-Age 3600 always;
            return 204;
        }
        
        proxy_pass http://nextjs_app;
        include /etc/nginx/proxy.conf;
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        
        # Cache GET requests only, for 1 minute
        proxy_cache api_cache;
        proxy_cache_methods GET HEAD;
        proxy_cache_valid 200 1m;
        proxy_cache_valid 404 30s;
        proxy_cache_key "$scheme$request_method$host$request_uri$is_args$args";
        add_header X-Cache-Status $upstream_cache_status always;
        
        # Don't cache POST, PUT, PATCH, DELETE
        proxy_no_cache $request_method;
        proxy_cache_bypass $request_method;
    }

    # ───────────────────────────────────────
    # Default - All other requests to Next.js
    # ───────────────────────────────────────
    
    location / {
        proxy_pass http://nextjs_app;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        include /etc/nginx/proxy.conf;
        
        # Next.js specific headers (proxy.conf already has proxy_http_version)
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        
        # Cache HTML pages for 5 minutes (with stale-while-revalidate)
        proxy_cache api_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_valid 404 1m;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        add_header X-Cache-Status $upstream_cache_status always;
        
        add_header Cache-Control "public, max-age=300, stale-while-revalidate=60";
    }

    # ───────────────────────────────────────
    # Security - Block hidden files
    # ───────────────────────────────────────
    
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}
