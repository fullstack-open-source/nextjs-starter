# ===========================================
# Nginx Security Configuration
# Optimized for Next.js Applications
# ===========================================

# ===========================================
# Rate Limiting Zones (Next.js Optimized)
# ===========================================

# General rate limiting (30 requests/second - Next.js apps make many requests)
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=30r/s;

# Strict rate limiting (10 requests/second)
limit_req_zone $binary_remote_addr zone=req_limit_per_ip_strict:10m rate=10r/s;

# Login rate limiting (5 requests/second - more lenient for Next.js)
limit_req_zone $binary_remote_addr zone=req_limit_per_ip_login:10m rate=5r/s;

# API rate limiting (50 requests/second - Next.js makes many API calls)
limit_req_zone $binary_remote_addr zone=req_limit_per_ip_api:10m rate=50r/s;

# Upload rate limiting (2 requests/second)
limit_req_zone $binary_remote_addr zone=req_limit_per_ip_upload:10m rate=2r/s;

# Connection limits (increased for Next.js)
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# ===========================================
# Request Size Limits (Next.js Optimized)
# ===========================================

client_max_body_size 100M;  # Increased for Next.js file uploads
client_body_buffer_size 256k;
client_header_buffer_size 2k;
large_client_header_buffers 4 16k;

# ===========================================
# Timeouts (Next.js Optimized)
# ===========================================

client_body_timeout 60s;      # Increased for Next.js
client_header_timeout 60s;    # Increased for Next.js
keepalive_timeout 65s;
send_timeout 60s;             # Increased for Next.js

# ===========================================
# Security Headers (Next.js Compatible)
# ===========================================

# XSS Protection
add_header X-XSS-Protection "1; mode=block" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Clickjacking protection
add_header X-Frame-Options "SAMEORIGIN" always;

# Referrer policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (Next.js compatible)
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=(), vibrate=(), fullscreen=(self), sync-xhr=(self)" always;

# Content Security Policy (Next.js Compatible)
# Allows Next.js features: inline scripts, eval (for HMR), WebSocket, etc.
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: blob:; connect-src 'self' ws: wss: http://localhost:* https://localhost:*; media-src 'self' blob:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self';" always;

# Strict Transport Security (HSTS) - Only if using HTTPS
# Uncomment when SSL/TLS is configured
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Remove server information
server_tokens off;

# ===========================================
# Block Common Attack Patterns (Next.js Safe)
# Note: "if" directives are in default.conf (server block)
# ===========================================

# Block suspicious user agents (very specific - don't block legitimate bots)
map $http_user_agent $block_agent {
    default 0;
    ~*malicious 1;
    # Allow common legitimate user agents
    ~*bot 0;
    ~*crawler 0;
    ~*spider 0;
    ~*curl 0;
    ~*wget 0;
    ~*postman 0;
    ~*insomnia 0;
    ~*httpie 0;
    ~*Mozilla 0;
    ~*Chrome 0;
    ~*Firefox 0;
    ~*Safari 0;
    ~*Edge 0;
    ~*Opera 0;
}

# Block suspicious referers (only known spam domains)
map $http_referer $block_referer {
    default 0;
    ~*\.tk/ 1;
    ~*\.ml/ 1;
    ~*\.ga/ 1;
    ~*\.cf/ 1;
    ~*\.gq/ 1;
}


# ===========================================
# Gzip Compression (Next.js Optimized)
# ===========================================

gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied any;
gzip_comp_level 6;
gzip_types 
    text/plain 
    text/css 
    text/xml 
    text/javascript 
    application/json 
    application/javascript 
    application/xml+rss 
    application/atom+xml 
    image/svg+xml 
    application/x-font-ttf 
    application/vnd.ms-fontobject 
    font/opentype
    application/manifest+json;

# ===========================================
# Rate Limiting Status
# ===========================================

limit_req_status 429;
limit_conn_status 429;

# ===========================================
# Security Logging
# ===========================================

# Custom log format for security events
log_format security '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'blocked=$block_agent$block_referer$block_args '
                    'rt=$request_time';


# Block requests with suspicious query strings (very specific - Next.js safe)
# Only block actual XSS patterns, not legitimate query parameters
map $args $block_args {
    default 0;
    # Only block actual XSS patterns, not common query param names
    ~*<script[^>]*> 1;           # Script tags
    ~*javascript\s*: 1;           # JavaScript protocol (with space)
    ~*onload\s*=\s*["'] 1;        # Event handlers with quotes
    ~*onerror\s*=\s*["'] 1;       # Event handlers with quotes
    
}